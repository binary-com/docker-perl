version: 2.1
orbs:
  docker: circleci/docker@1.4.0

jobs:
    build_and_publish:
      executor: docker/docker
      parameters:
        push:
          type: boolean
          default: false
        image:
          type: string
          default: deriv/perl
        path:
          type: string
          default: .
        docker-context:
          type: string
          default: .
      steps:
        - setup_remote_docker
        - checkout
        - docker/build:
            image: <<parameters.image>>
            path: <<parameters.path>>
            docker-context: <<parameters.docker-context>>
        - when:
            condition: <<parameters.push>>
            steps:
              - docker/push:
                  image: <<parameters.image>>
workflows:
  version: 2
  build-workflow:
    jobs:
      - build_and_publish:
          context: perl
          name: perl
      - build_and_publish:
          context: perl
          requires:
              - perl
          name: dzil
          image: deriv/dzil
          path: dzil/
          docker-context: dzil/
      - docker/hadolint:
          dockerfiles: Dockerfile:dzil/Dockerfile
          # Don't pin apt versions, we'll never remember to update them
          ignore-rules: DL3008,SC2046,DL3003,DL4006,DL3006
 
